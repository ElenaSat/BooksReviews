name: Azure - Build, Push to Docker Hub and Deploy

on:
  push:
    branches: [ main, master ]

permissions:
  contents: read
  id-token: write

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      IMAGE_API: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/booksreviews-api:latest
      IMAGE_FRONT: docker.io/${{ secrets.DOCKERHUB_USERNAME }}/booksreviews-frontend:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push API image to Docker Hub
        uses: docker/build-push-action@v4
        with:
          context: ./BooksReviews.Api
          file: ./BooksReviews.Api/Dockerfile
          push: true
          tags: ${{ env.IMAGE_API }}

      - name: Build and push Frontend image to Docker Hub
        uses: docker/build-push-action@v4
        with:
          context: ./FrontBooksReviews
          file: ./FrontBooksReviews/Dockerfile
          push: true
          tags: ${{ env.IMAGE_FRONT }}

      - name: Deploy API image to Azure Web App (Docker Hub)
        if: ${{ secrets.WEBAPP_NAME != '' && secrets.RESOURCE_GROUP != '' }}
        run: |
          az webapp config container set \
            --name ${{ secrets.WEBAPP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --docker-custom-image-name ${IMAGE_API} \
            --docker-registry-server-url https://index.docker.io \
            --docker-registry-server-user ${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-registry-server-password ${{ secrets.DOCKERHUB_TOKEN }}

      - name: (Optional) Deploy Frontend image to Azure Web App (Docker Hub)
        if: ${{ secrets.FRONTEND_WEBAPP_NAME != '' && secrets.RESOURCE_GROUP != '' }}
        run: |
          az webapp config container set \
            --name ${{ secrets.FRONTEND_WEBAPP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --docker-custom-image-name ${IMAGE_FRONT} \
            --docker-registry-server-url https://index.docker.io \
            --docker-registry-server-user ${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-registry-server-password ${{ secrets.DOCKERHUB_TOKEN }}

  # Notes: set the following repository secrets before using this workflow:
  # - AZURE_CREDENTIALS : JSON for a service principal with permissions to the resource group
  # - DOCKERHUB_USERNAME and DOCKERHUB_TOKEN : for pushing images to Docker Hub
  # - WEBAPP_NAME : name of the App Service for the API (optional)
  # - FRONTEND_WEBAPP_NAME : name of the App Service for the frontend (optional)
  # - RESOURCE_GROUP : resource group containing the App Service
